# Installing the base system

::: tip The official Gentoo Handbook
The following guide has been written using the official [Gentoo Handbook][handbook]. It is strongly recommended to refer to the [handbook][handbook] in case of any situation, not covered by the guide, or for adapting the guide to your specific preferences.
:::

To start installing `Gentoo` alongside `Ghost Spectre`, boot from the bootable media by repeatedly pressing `F2` (at least on lenovo laptops) when turning on your `PC`, BIOS settings should open - configure `USB` as a boot device with higher priority than `Windows Bootloader`, press `F10` to reboot. Then in `ventoy` boot menu choose `Gentoo Installation` medium - after a few minutes command line should open with a prompt.

::: tip Opening a new shell
To open a new shell from the installer, press `ALT + F2`. To switch back, to the previous shell, press `ALT + F1`. Other `F` keys should also work the same way.
:::


Suppose we want to run a remote installation, meaning that we want to connect via `ssh` to the target device and control installation from there. Then, first of all, we should connect the target device to the Internet.

::: tabs

== Ethernet

If you are using `Ethernet` cable, no additional configuration is required in most cases, as minimal installation CD supports most hardware by default.

== Wi-Fi

When you need to connect to the Internet via `wifi`, you can use `nmtui` tool, which has an intuitive interface - just choose your network from the list and type password.

:::

To make sure you are connected to the Internet, run the following command, which should print your external IP address:

```sh
curl ifconfig.me
```

## Enabling remote installation

To enable remote installation, set root password (I recommend using something simple, like just `root` - this will be reset on reboot):

```sh
passwd root
```

Create a new user and create their `home` directory, which might be useful even on this stage, then set password:

```sh
useradd -m -G users,wheel zeio
passwd zeio
```

Change default editor to `vim` if you are more comfortable with `vim` than with `nano`:

```sh
export EDITOR=vim
```

Then add the new user to the `sudoers` list. For that run the following command:

```sh
visudo
```

A file will be open for editing, add a new line near line with `root` user configuration:

```sh
root ALL=(ALL:ALL) ALL
zeio ALL=(ALL) NOPASSWD: ALL  # [!code ++]
```

Then check your ip address in the local network for being able to connect to the target device by `ssh`:

```sh
ifconfig | grep 192 | cut -d ' ' -f10
```

Finally, start `ssh` service:

```sh
rc-service sshd start
```

Now `ssh` connections to the target device should be supported.

## Preparing the disks

::: tip The Official Gentoo Handbook
For more details see [the corresponding section](https://wiki.gentoo.org/wiki/Handbook:AMD64/Installation/Disks) of the official Gentoo Handbook.
:::

First, list all installed drives and partitions:

```sh
lsblk
```

The command outputs something like:

```sh{3}
NAME       MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0        7:0    0   687M  1 loop /run/rootfsbase
sda          8:0    0 894.3G  0 disk
├─sda1       8:1    0   200M  0 part
├─sda2       8:2    0    16M  0 part
├─sda3       8:3    0 127.3G  0 part
└─sda4       8:4    0   735M  0 part
sdb          8:16   1  14.5G  0 disk
├─sdb1       8:17   1  14.4G  0 part
│ ├─ventoy 253:0    0 779.9M  1 dm   /run/initramfs/live
│ └─sdb1   253:1    0  14.4G  0 dm
└─sdb2       8:18   1    32M  0 part
sr0         11:0    1  1024M  0 rom
```

The highlighted line here indicates the disk we will be working with, this disk has a lot of unallocated space, so we can create a new partition here, which will be used for our linux installation. Use `fdisk` tool for working with the disk:

```sh
sudo fdisk /dev/sda
```

Use `p` key to display current partition layout.

::: danger Wiping existing data
To wipe all existing data on the disk, either press `g` which will instantly overwrite current partition layout with a new GPT disklabel, or press `d` to remove partitions one by one to keep existing disklabel. These actions lead to data loss and have to be made with caution.
:::

To create a new partition, type `n`, leave `partition number` default (`5` in my case), first sector - default value (`268877824` in my case) and default value for the last sector (`1875384319` in my case). Press `p` again to check that everything is correct, and `w` to write changes. If I run `lsblk` now, I get the following output (the new partition is highlighted):

```sh{8}
NAME       MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0        7:0    0   687M  1 loop /run/rootfsbase
sda          8:0    0 894.3G  0 disk
├─sda1       8:1    0   200M  0 part
├─sda2       8:2    0    16M  0 part
├─sda3       8:3    0 127.3G  0 part
├─sda4       8:4    0   735M  0 part
└─sda5       8:5    0   766G  0 part
sdb          8:16   1  14.5G  0 disk
├─sdb1       8:17   1  14.4G  0 part
│ ├─ventoy 253:0    0 779.9M  1 dm   /run/initramfs/live
│ └─sdb1   253:1    0  14.4G  0 dm
└─sdb2       8:18   1    32M  0 part
sr0         11:0    1  1024M  0 rom
```

Create filesystem on the newly created partition:

```sh
sudo mkfs.ext4 /dev/sda5
```

Now we need to mount the newly created partition:

```sh
sudo mount /dev/sda5 /mnt/gentoo
```

## Preparing Gentoo installation files

Change the root directory permissions:

```sh
sudo chown zeio:zeio /mnt/gentoo
```

Move to the mounted partition:

```sh
cd /mnt/gentoo
```

Here we need to download the `stage file`. For choosing the appropriate file, use the built-in browser:

```sh
links https://www.gentoo.org/downloads/mirrors/
```

Select `Downloads`, then navigate to `amd64 Stage 3 openrc` - download the `.tar.xz` file. Press `q` to exit `links` after the file is downloaded, then run the following command to unzip the downloaded content:

```sh
sudo tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner -C /mnt/gentoo
```

### Configuring compile options

Open `make.conf` using the following command:

```sh
sudo vim /mnt/gentoo/etc/portage/make.conf
```

Change the file like this (to determine the value for `-j` flag in `MAKEOPTS`, run `nproc` command, set `-l` slightly above this value):

```sh
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.
COMMON_FLAGS="-O2 -pipe" # [!code --]
COMMON_FLAGS="-march=native -O2 -pipe" # [!code ++]
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"  # [!code ++]
MAKEOPTS="-j4 -l5" # [!code ++]

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8
```

## Installing the base system

Copy DNS information:

```sh
sudo cp --dereference /etc/resolv.conf /mnt/gentoo/etc
```

Then chroot to the new system:

```sh
sudo arch-chroot /mnt/gentoo && source /etc/profile
> export PS1="(chroot) ${PS1}"
```

Mount `efi` partition (in my case - `/dev/sda1`):

```sh
mkdir /efi
mount /dev/sda1 /efi
```

Then fetch the latest snapshot of `emerge` package registry:

```sh
emerge-webrsync
```

Select mirrors by using a special tool:

```sh
emerge --ask --verbose --oneshot app-portage/mirrorselect
mirrorselect -i -o >> /etc/portage/make.conf
```

I usually choose these mirrors:

```sh{20-26}
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.
COMMON_FLAGS="-march=native -O2 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"
MAKEOPTS="-j4 -l5"

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8

GENTOO_MIRRORS="http://mirror.mephi.ru/gentoo-distfiles/ \
    ftp://mirror.mephi.ru/gentoo-distfiles/ \
    rsync://mirror.mephi.ru/gentoo-distfiles/ \
    https://mirror.yandex.ru/gentoo-distfiles/ \
    http://mirror.yandex.ru/gentoo-distfiles/ \
    ftp://mirror.yandex.ru/gentoo-distfiles/"
```

Then update `emerge` repositories:

```sh
emerge --sync
```

Set up `cpu flags`. You need to install a special package:

```sh
emerge --ask --oneshot app-portage/cpuid2cpuflags
```

Examine the output:

```sh
cpuid2cpuflags
```

Then copy the output to `package.use`:

```sh
echo "*/* $(cpuid2cpuflags)" > /etc/portage/package.use/00cpu-flags
```

Configure video card options:

::: tabs

=== Nvidia GPU

```sh
echo '*/* VIDEO_CARDS: nvidia' > /etc/portage/package.use/00video_cards
```

=== AMD GPU

```sh
echo '*/* VIDEO_CARDS: amdgpu radeonsi' > /etc/portage/package.use/00video_cards
```

:::

For being able to edit files manually under `chroot` and further, after rebooting into the configured system, now is the right time to install `vim` editor:

```sh
emerge --ask app-editors/vim
```

While `vim` is being installed, configure global `USE` flags in the `make.conf`:

::: tabs

=== Nvidia GPU

```sh
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.

USE="-gtk -gnome X dist-kernel dbus alsa wayland bluetooth opengl nvenc cuda lua v4l screencast" # [!code ++]

COMMON_FLAGS="-march=native -O2 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"
MAKEOPTS="-j4 -l5"

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8

GENTOO_MIRRORS="http://mirror.mephi.ru/gentoo-distfiles/ \
    ftp://mirror.mephi.ru/gentoo-distfiles/ \
    rsync://mirror.mephi.ru/gentoo-distfiles/ \
    https://mirror.yandex.ru/gentoo-distfiles/ \
    http://mirror.yandex.ru/gentoo-distfiles/ \
    ftp://mirror.yandex.ru/gentoo-distfiles/"
```

=== AMD GPU

```sh
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.

USE="-gtk -gnome X dist-kernel dbus alsa wayland bluetooth opengl lua v4l screencast" # [!code ++]

COMMON_FLAGS="-march=native -O2 -pipe"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"
MAKEOPTS="-j4 -l5"

# NOTE: This stage was built with the bindist USE flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C.UTF-8

GENTOO_MIRRORS="http://mirror.mephi.ru/gentoo-distfiles/ \
    ftp://mirror.mephi.ru/gentoo-distfiles/ \
    rsync://mirror.mephi.ru/gentoo-distfiles/ \
    https://mirror.yandex.ru/gentoo-distfiles/ \
    http://mirror.yandex.ru/gentoo-distfiles/ \
    ftp://mirror.yandex.ru/gentoo-distfiles/"
```

:::

After changing `USE` flags update the `@world` set:

```sh
emerge --ask --verbose --update --deep --changed-use @world
```

Unmerge unnecessary packages:

```sh
emerge --ask --depclean
```

### Configuring timezone

Run the following timezone to configure `UTC+3` as your timezone:

```sh
ln -sf ../usr/share/zoneinfo/Europe/Moscow /etc/localtime
```

### Configuring locale

Uncomment required locales in the file `/etc/locale.gen`:

```sh
# en_US.UTF-8       UTF-8  # American English (United States)
en_US.UTF-8       UTF-8  # American English (United States) [!code ++]
# ru_RU.UTF-8       UTF-8  # Russian (Russia)
ru_RU.UTF-8       UTF-8  # Russian (Russia) [!code ++]
```

Then generate selected locales:

```sh
locale-gen
```

Reload the environment:

```sh
env-update && source /etc/profile
> export PS1="(chroot) ${PS1}"
```

To use font with russian glyphs, edit file `/etc/conf.d/consolefont` like this:

```sh
# The consolefont service is not activated by default. If you need to
# use it, you should run "rc-update add consolefont boot" as root.
#
# consolefont specifies the default font that you'd like Linux to use on the
# console.  You can find a good selection of fonts in /usr/share/consolefonts;
# you shouldn't specify the trailing ".psf.gz", just the font name below.
# To use the default console font, comment out the CONSOLEFONT setting below.
consolefont="default8x16"  # [!code --]
consolefont="LatArCyrHeb-16"  # [!code ++]

# consoletranslation is the charset map file to use.  Leave commented to use
# the default one.  Have a look in /usr/share/consoletrans for a selection of
# map files you can use.
#consoletranslation="8859-1_to_uni"

# unicodemap is the unicode map file to use. Leave commented to use the
# default one. Have a look in /usr/share/unimaps for a selection of map files
# you can use.
#unicodemap="iso01"
```

Apply the new configuration by restarting `consolefont` service:

```sh
rc-service consolefont restart
```

Next add `consolefont` init script to `boot` level:

```sh
rc-update add consolefont boot
```

## Configuring the Linux kernel

Enable `grub` and `dracut` flags for `installkernel` module:

```sh
echo 'sys-kernel/installkernel grub dracut' > /etc/portage/package.use/installkernel
```

Create `dracut` configuration file, which specifies the disk with system root. In the following command, replace `/dev/sda5` with taget disk and run the result:

```sh
if test ! -d /etc/dracut.conf.d; then mkdir /etc/dracut.conf.d; fi
echo "kernel_cmdline=\" root=$(blkid /dev/sda5 | cut -d ' ' -f2 | cut -d '"' -f2) \"" > /etc/dracut.conf.d/00-installkernel.conf
```

Install `linux-firmware`. First, allow the required license:

```sh
if test ! -d /etc/portage/package.license; then mkdir /etc/portage/package.license; fi
echo 'sys-kernel/linux-firmware linux-fw-redistributable' > /etc/portage/package.license/linux-firmware
```

::: warning Long-running command

The following command might take a lot of time depending on your hardware (on 4-core `AMD A8 6410` it took 12 hours), because it will compile and install kernel due to enabled `dist-kernel` global `USE` flag. To check the installation progress, run the following command in a separate terminal:

```sh
sudo tail -n 100 -f /mnt/gentoo/var/log/emerge.log | awk -F ':  ' '{ printf "%s:  %s\n", strftime("%d-%m-%Y %H:%M:%S", $1), $2 }'
```

:::

To install `linux-firmware` (and `gentoo-kernel` due to enabled `dist-kernel` flag), run the following command:

```sh
emerge --ask sys-kernel/linux-firmware
```

Then install `sof-firmware`:

```sh
emerge --ask sys-firmware/sof-firmware
```

## Configuring the system

Now we will configure disk mounts which will run on the system startup. For being able to mount windows partition, install the following package with provides `linux` with `ntfs` tools:

```sh
emerge --ask sys-fs/ntfs3g
```

Create directory for mounting `windows` partition:

```sh
mkdir /mnt/windows
```

Now suppose that `efi` partition corresponds to `/dev/sda1`, `windows` partition - to `/dev/sda3` and `linux` partition - to `/sda/sda5` (as in examples above). Then by running `blkid` commands we can trace `UUIDs` of the required partitions, these `UUIDs` we will use to refer to the partitions when writing `fstab` file:

```sh{2,3,9}
/dev/mapper/ventoy: BLOCK_SIZE="2048" UUID="2026-01-05-11-46-37-00" LABEL="Gentoo-amd64-20260105" TYPE="iso9660" PTUUID="4249dc9e-a1b6-4e69-a524-ca6cf6699236" PTTYPE="gpt"
/dev/sda5: UUID="77d88192-bf65-4eae-98e7-9e1954701177" BLOCK_SIZE="4096" TYPE="ext4" PARTUUID="f2e53cdf-871b-46d7-929e-f4e279a40c2f"
/dev/sda1: UUID="2819-A675" BLOCK_SIZE="512" TYPE="vfat" PARTLABEL="Basic data partition" PARTUUID="c6c8fbd2-dd9c-4942-9516-05be83d812f8"
/dev/mapper/sdb1: LABEL="Ventoy" UUID="4E21-0000" BLOCK_SIZE="512" TYPE="exfat"
/dev/sdb2: SEC_TYPE="msdos" LABEL_FATBOOT="VTOYEFI" LABEL="VTOYEFI" UUID="E039-AD96" BLOCK_SIZE="512" TYPE="vfat" PARTUUID="6034684f-02"
/dev/sdb1: LABEL="Ventoy" UUID="4E21-0000" BLOCK_SIZE="512" TYPE="exfat" PARTUUID="6034684f-01"
/dev/loop0: BLOCK_SIZE="131072" TYPE="squashfs"
/dev/sda4: BLOCK_SIZE="512" UUID="F83C509F3C505AA8" TYPE="ntfs" PARTUUID="58c7751f-2672-4ca8-8b66-7351aac416b6"
/dev/sda3: BLOCK_SIZE="512" UUID="6EBA1DC9BA1D8EA9" TYPE="ntfs" PARTLABEL="Basic data partition" PARTUUID="2f1a82b5-ea07-4301-8cd0-8dea14cb7390"
/dev/sda2: PARTLABEL="Microsoft reserved partition" PARTUUID="2921a2e9-29c1-402a-ad06-be4c4fdbe92f"
```

Edit `/etc/fstab` file like this:

```sh
# /etc/fstab: static file system information.
#
# See the manpage fstab(5) for more information.
#
# NOTE: The root filesystem should have a pass number of either 0 or 1.
#       All other filesystems should have a pass number of 0 or greater than 1.
#
# NOTE: Even though we list ext4 as the type here, it will work with ext2/ext3
#       filesystems.  This just tells the kernel to use the ext4 driver.
#
# NOTE: You can use full paths to devices like /dev/sda3, but it is often
#       more reliable to use filesystem labels or UUIDs. See your filesystem
#       documentation for details on setting a label. To obtain the UUID, use
#       the blkid(8) command.

# <fs>			<mountpoint>	<type>		<opts>		<dump> <pass>

#LABEL=boot		/boot		ext4		defaults	1 2
#UUID=58e72203-57d1-4497-81ad-97655bd56494		/		xfs		defaults		0 1
#LABEL=swap		none		swap		sw		0 0
#/dev/cdrom		/mnt/cdrom	auto		noauto,ro	0 0
UUID=77d88192-bf65-4eae-98e7-9e1954701177		/	ext4		defaults,noatime	0 1 # [!code ++]
UUID=6EBA1DC9BA1D8EA9		/mnt/windows	ntfs-3g		defaults,noatime	0 0 # [!code ++]
UUID=2819-A675		/efi	vfat		umask=0077,tz=UTC	0 2 # [!code ++]
```

Use the following commands to verify `fstab` file (the first one is just checking the correctness of the file, the second one is mounting all partitions which are not already mounted):

```sh
findmnt --verify
mount -a
```

Next, we are going to configure the network. Set the hostname (replace `gore` with preferred value):

```sh
echo gore > /etc/hostname
```

Configure `dhcp` service:

```sh
rc-update add dhcpcd default
rc-service dhcpcd start 
```

::: tip DHCP package installation

If `DHCP` is not installed as a result of running commands above, install it manually using the following command:

```sh
emerge --ask net-misc/dhcpcd
```

:::

## Configure essential system properties

For convenience install `tree`, `sudo` and `eselect-repository` packages:

```sh
emerge --ask app-text/tree app-admin/sudo app-eselect/eselect-repository
```

Set root password:

```sh
passwd
```

Enable `russian` keymap by editing file `/etc/conf.d/keymaps`:

```sh
# Use keymap to specify the default console keymap.  There is a complete tree
# of keymaps in /usr/share/keymaps to choose from.
keymap="us"  # [!code --]
keymap="ru"  # [!code ++]

# Should we first load the 'windowkeys' console keymap?  Most x86 users will
# say "yes" here.  Note that non-x86 users should leave it as "no".
# Loading this keymap will enable VT switching (like ALT+Left/Right)
# using the special windows keys on the linux console.
windowkeys="YES"

# The maps to load for extended keyboards.  Most users will leave this as is.
extended_keymaps=""
#extended_keymaps="backspace keypad euro2"

# Tell dumpkeys(1) to interpret character action codes to be
# from the specified character set.
# This only matters if you set unicode="yes" in /etc/rc.conf.
# For a list of valid sets, run `dumpkeys --help`
dumpkeys_charset=""

# Some fonts map AltGr-E to the currency symbol instead of the Euro.
# To fix this, set to "yes"
fix_euro="NO"
```

To apply the changes, restart the `keymaps` service:

```sh
rc-service keymaps restart
```

And add the service to `boot` runlevel:

```sh
rc-update add keymaps boot
```

::: tip Switching keyboard layouts

Keyboard layouts are switched using `Ctrl + Shift + Space` hotkey

:::

Edit `/etc/conf.d/hwclock`:

```sh
# Set CLOCK to "UTC" if your Hardware Clock is set to UTC (also known as
# Greenwich Mean Time).  If that clock is set to the local time, then
# set CLOCK to "local".  Note that if you dual boot with Windows, then
# you should set it to "local".
clock="UTC" # [!code --]
clock="clock" # [!code ++]

# If you want the hwclock script to set the system time (software clock)
# to match the current hardware clock during bootup, leave this
# commented out.
# However, you can set this to "NO" if you are running a modern kernel
# and using NTP to synchronize your system clock.
#clock_hctosys="YES"

# If you do not want to set the hardware clock to the current system
# time (software clock) during shutdown, set this to no.
#clock_systohc="YES"

# If you wish to pass any other arguments to hwclock during bootup,
# you may do so here. Alpha users may wish to use --arc or --srm here.
clock_args=""
```

## Install system tools

Install logging service, I recommend using `metalog` for high configurability and fancy name:

```sh
emerge --ask app-admin/metalog
```

Then add it to the `default` runlevel:

```sh
rc-update add metalog default
```

::: tip Search in system logs

To search in system logs when using `metalog`, run command like:

```sh
sudo bash -c 'for file in /var/log/everything/*; do echo; echo $file; echo; cat $file | grep hyprland; done'
```

To search in `dmesg` output:

```sh
sudo dmesg -T | grep -i bluetooth
```

:::

And start the service:

```sh
rc-service metalog start
```

Optionally, check current log:

```sh
tail -f /var/log/everything/current
```

Install cron service. I recommend using `fcron` for extended capabilities over `cron` and `anacron`:

```sh
emerge --ask sys-process/fcron
```

Then configure `fcron`:

```sh
emerge --config sys-process/fcron
```

Install `mlocate` to index file systems for faster search:

```sh
emerge --ask sys-apps/mlocate
```

::: tip Bash completions

If you are planning to use `bash` as the main shell, you can now install bash completions:

```sh
emerge --ask app-shells/bash-completion
```

However, I recommend omitting this step and switch to `zsh` in the next chapter.

:::

Install `chrony` for synchronizing system clock:

```sh
emerge --ask net-misc/chrony
```

Add `chrony` to the `default` runlevel:

```sh
rc-update add chronyd default
```

Install `io-scheduler-udev-rules`:

```sh
emerge --ask sys-block/io-scheduler-udev-rules
```

Install wireless networking tools:

```sh
emerge --ask net-wireless/iw net-wireless/wpa_supplicant
```

## Configuring bootloader

Make sure `efi` partition is mounted to `/efi`, then install `grub` there:

```sh
grub-install --efi-directory=/efi
```

The output should match exactly the following text:

```sh
Installing for x86_64-efi platform.
Installation finished. No error reported.
```

If we reboot the system right now, grub won't have menu entries for windows, because it doesn't detect the other operating systems on the device by default. Therefore, we need to add windows to grub menu. It is done by installing the following package:

```sh
emerge --ask sys-boot/os-prober
```

As a result of running this command, `emerge` will likely ask you to add `mount` flag to `sys-boot/grub` package, to accept the change type `Yes` and then run command `etc-update`. Then press `1`, then `q`, then `1`, then type `yes`. The changes will be written to `/etc/portage/package.use/installkernel`. Now try to install the package again.

If package is installed successfully, check that it detects windows:

```sh
os-prober
```

If windows is detected, then edit `grub` configuration at `/etc/default/grub` (append one line):

```sh
#GRUB_INIT_TUNE="60 800 1"
GRUB_DISABLE_OS_PROBER=false # [!code ++]
```

Then backup the old boot configuration file:

```sh
cp /boot/grub/grub.cfg /boot/grub/grub.cfg.old
```

And generate the new boot config:

```sh
grub-mkconfig -o /boot/grub/grub.cfg
```

Check that `windows` menu entry has been added:

```sh
diff /boot/grub/grub.cfg.old /boot/grub/grub.cfg
```

## Reboot

Then exit the shell and unmount disks:

```sh
exit
cd
umount -R /mnt/gentoo
reboot
```

After reboot you may need to enter boot menu again to assign higher priority for gentoo bootloader.

[handbook]: https://wiki.gentoo.org/wiki/Handbook:AMD64
